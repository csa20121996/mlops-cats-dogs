name: CD - Deploy to Local Kubernetes

on:
  workflow_run:
    workflows: ["CI - Build, Test & Push"]
    types: [completed]
    branches: ["**"]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    defaults:
      run:
        shell: cmd

    steps:
      - name: Check Kubernetes
        run: kubectl get nodes

      - name: Pull Release Image (v<CI run_number>)
        run: docker pull ghcr.io/${{ github.repository }}:v${{ github.event.workflow_run.run_number }}

      - name: Deploy Release Image
        run: |
          echo Deploying ghcr.io/${{ github.repository }}:v${{ github.event.workflow_run.run_number }}
          kubectl set image deployment/mlops-app mlops-container=ghcr.io/${{ github.repository }}:v${{ github.event.workflow_run.run_number }}

      - name: Wait for Rollout
        run: kubectl rollout status deployment/mlops-app --timeout=180s

      - name: Smoke Test - Health + Predict (in-cluster)
        run: |
          echo Running smoke test with retries...
          for /L %%i in (1,1,12) do (
            echo Attempt %%i...

            kubectl run smoke-test --rm -i --restart=Never --image=alpine:3.20 -- ^
              sh -c "apk add --no-cache curl > /dev/null && ^
                    echo iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVR4nGP4z8AAAAMBAQDJ/pLvAAAAAElFTkSuQmCC | base64 -d > /tmp/smoke.png && ^
                    curl -fsS http://mlops-service:8000/health && ^
                    curl -fsS -F file=@/tmp/smoke.png http://mlops-service:8000/predict"

            if not errorlevel 1 (
              echo Smoke test passed!
              exit /b 0
            )
            echo Not ready yet. Waiting 10s...
            timeout /t 10 /nobreak >nul
          )
          echo Smoke test failed after retries!
          exit /b 1

      - name: Rollback on Failure
        if: failure()
        run: |
          echo Rolling back...
          kubectl rollout undo deployment/mlops-app
          kubectl rollout status deployment/mlops-app --timeout=180s