name: CD - Deploy to Local Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    defaults:
      run:
        shell: cmd

    steps:
      - name: Check Kubernetes Cluster
        run: kubectl get nodes

      - name: Set Image Version
        run: echo VERSION=v${{ github.event.workflow_run.run_number }} >> %GITHUB_ENV%

      - name: Pull Image From GHCR (Fail Fast If Missing)
        run: docker pull ghcr.io/${{ github.repository }}:v${{ github.event.workflow_run.run_number }}

      - name: Deploy New Version
        run: |
          echo Deploying ghcr.io/${{ github.repository }}:v${{ github.event.workflow_run.run_number }}
          kubectl set image deployment/mlops-app mlops-container=ghcr.io/${{ github.repository }}:v${{ github.event.workflow_run.run_number }}

      - name: Wait For Rollout
        run: kubectl rollout status deployment/mlops-app --timeout=180s

      - name: Show Current Deployment Image
        run: kubectl get deployment mlops-app -o=jsonpath="{.spec.template.spec.containers[0].image}"

      # -----------------------------
      # SMOKE TEST (Inside Cluster)
      # -----------------------------
      - name: Smoke Test - Health Endpoint
        run: |
          echo Running smoke test...
          kubectl run smoke-test --rm -i --restart=Never --image=curlimages/curl -- ^
            curl -f http://mlops-service:8000/health
          if errorlevel 1 (
              echo Smoke test failed!
              exit /b 1
          )
          echo Smoke test passed!

      # -----------------------------
      # AUTOMATIC ROLLBACK
      # -----------------------------
      - name: Rollback on Failure
        if: failure()
        run: |
          echo Rolling back to previous version...
          kubectl rollout undo deployment/mlops-app
          kubectl rollout status deployment/mlops-app --timeout=180s
