name: CD - Deploy to Local Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Check Kubernetes
        run: kubectl get nodes

      - name: Pull Latest Image
        run: docker pull ghcr.io/${{ github.repository }}:latest

      - name: Update Deployment
        run: |
          kubectl set image deployment/mlops-app mlops-container=ghcr.io/${{ github.repository }}:latest

      - name: Wait for Rollout
        run: kubectl rollout status deployment/mlops-app

      - name: Port Forward
        run: |
          Start-Process kubectl -ArgumentList "port-forward service/mlops-service 8000:8000"
          Start-Sleep -Seconds 10

      - name: Start Minikube Tunnel and Get URL
        shell: powershell
        run: |
          $url = (minikube service mlops-service --url | Select-Object -First 1).Trim()
          echo "SERVICE_URL=$url" >> $env:GITHUB_ENV
          Write-Host "Service URL: $url"

      - name: Smoke Test
        shell: powershell
        run: |
          Write-Host "Testing $env:SERVICE_URL/health"
          try {
            $r = Invoke-WebRequest -Uri "$env:SERVICE_URL/health" -UseBasicParsing -TimeoutSec 15
            Write-Host "StatusCode=$($r.StatusCode)"
            Write-Host "Body=$($r.Content)"
            if ($r.StatusCode -ne 200) { throw "Non-200 status code" }
          } catch {
            Write-Host "Smoke test failed:"
            Write-Host $_.Exception.Message
            exit 1
          }

      - name: Rollback on Failure
        if: failure()
        run: kubectl rollout undo deployment/mlops-app
