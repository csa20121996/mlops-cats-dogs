name: CD - Deploy to Local Kubernetes

on:
  push:
    branches:
      - "**" # any branch

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: cmd

    steps:
      - name: Check Kubernetes
        run: kubectl get nodes

      - name: Pull Release Image (v28-test)
        run: docker pull ghcr.io/${{ github.repository }}:v28-test

      - name: Deploy Release Image (v28-test)
        run: |
          echo Deploying ghcr.io/${{ github.repository }}:v28-test
          kubectl set image deployment/mlops-app mlops-container=ghcr.io/${{ github.repository }}:v28-test

      - name: Wait for Rollout
        run: kubectl rollout status deployment/mlops-app --timeout=180s

      - name: Small wait after rollout
        shell: cmd
        run: |
          echo Waiting 5 seconds for service endpoints to settle...
          ping -n 6 127.0.0.1 >nul

      - name: Smoke Test - Health + Predict (in-cluster)
        shell: cmd
        run: |
          echo Running smoke test with retries...
          for /L %%i in (1,1,12) do (
            echo Attempt %%i...
            kubectl run smoke-test --rm -i --restart=Never --image=alpine:3.20 -- sh -c "apk add --no-cache curl > /dev/null; echo iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVR4nGP4z8AAAAMBAQDJ/pLvAAAAAElFTkSuQmCC | base64 -d > /tmp/smoke.png; curl -fsS http://mlops-service:8000/health; curl -fsS -F file=@/tmp/smoke.png http://mlops-service:8000/predict"
            if not errorlevel 1 (
              echo Smoke test passed!
              exit /b 0
            )
            echo Not ready yet. Waiting 10s...
            ping -n 11 127.0.0.1 >nul
          )
          echo Smoke test failed after retries!
          exit /b 1

      - name: Rollback on Failure
        if: failure()
        run: |
          echo Rolling back...
          kubectl rollout undo deployment/mlops-app
          kubectl rollout status deployment/mlops-app --timeout=180s