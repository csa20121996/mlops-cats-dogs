name: CD - Deploy to Local Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: cmd

    steps:
      - name: Check Kubernetes
        run: kubectl get nodes

      - name: Pull Latest Image
        run: docker pull ghcr.io/%GITHUB_REPOSITORY%:latest

      - name: Update Deployment
        run: kubectl set image deployment/mlops-app mlops-container=ghcr.io/%GITHUB_REPOSITORY%:latest

      - name: Wait for Rollout
        run: kubectl rollout status deployment/mlops-app

      - name: Port Forward
        run: |
          start "" kubectl port-forward service/mlops-service 8000:8000
          timeout /t 10

      - name: Smoke Test via Minikube Service
        run: |
          echo Fetching service URL...

          FOR /F "tokens=*" %%i IN ('minikube service mlops-service --url') DO (
              set SERVICE_URL=%%i
              goto :done
          )
          :done

          echo Service URL: %SERVICE_URL%
          set HEALTH_URL=%SERVICE_URL%/health
          echo Testing: %HEALTH_URL%

          curl -f %HEALTH_URL%
          if errorlevel 1 (
              echo Smoke test failed!
              exit /b 1
          )

          echo Smoke test passed!
          exit /b 0

      - name: Rollback on Failure
        if: failure()
        run: kubectl rollout undo deployment/mlops-app
