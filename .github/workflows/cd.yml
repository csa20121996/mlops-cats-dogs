name: CD - Deploy to Local Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: cmd

    steps:
      - name: Check Kubernetes
        run: kubectl get nodes

      - name: Deploy New Image (Using Commit SHA)
        run: |
          echo Updating deployment with image tag %GITHUB_SHA%
          kubectl set image deployment/mlops-app mlops-container=ghcr.io/%GITHUB_REPOSITORY%:%GITHUB_SHA%

      - name: Wait for Rollout
        run: kubectl rollout status deployment/mlops-app --timeout=120s

      - name: Show Rollout History
        run: kubectl rollout history deployment/mlops-app

      - name: Smoke Test (Cluster Internal)
        run: |
          echo Running health check inside cluster...
          kubectl run curl-test --rm -i --restart=Never --image=curlimages/curl -- ^
            curl -f http://mlops-service:8000/health
          if errorlevel 1 (
              echo Smoke test failed!
              exit /b 1
          )
          echo Smoke test passed!

      - name: Rollback on Failure
        if: failure()
        run: |
          echo Rolling back to previous revision...
          kubectl rollout undo deployment/mlops-app
          kubectl rollout status deployment/mlops-app --timeout=120s
